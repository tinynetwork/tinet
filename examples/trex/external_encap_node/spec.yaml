#   (net0) ---+
# T1         HV1 -- CLOS----BR
#   (net1) ---+             |
#                     L1----+
#                           |
#                     N1----+
nodes:
- name: T1
  image: tinynetwork/trex:develop
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: HV1#net1 }
  - { name: net1, type: direct, args: HV1#net2 }
  sysctls:
  - sysctl: net.ipv6.conf.all.disable_ipv6=0
  - sysctl: net.ipv6.conf.default.disable_ipv6=0
- name: HV1
  image: slankdev/vpp:19.04
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: BR#hv1 }
  - { name: net1, type: direct, args: T1#net0 }
  - { name: net2, type: direct, args: T1#net1 }
  sysctls:
  - sysctl: net.ipv6.conf.all.disable_ipv6=0
  - sysctl: net.ipv6.conf.default.disable_ipv6=0
- name: BR
  image: nicolaka/netshoot
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: hv1, type: direct, args: HV1#net0 }
  - { name: l1, type: direct, args: L1#net0 }
  - { name: n1, type: direct, args: N1#net0 }
  sysctls: []
- name: L1
  image: ghcr.io/slankdev/mfplane-mfpctl:branch-main
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: BR#l1 }
  sysctls:
  - sysctl: net.ipv4.ip_forward=1
  - sysctl: net.ipv6.conf.all.disable_ipv6=0
  - sysctl: net.ipv6.conf.default.disable_ipv6=0
- name: N1
  image: ghcr.io/slankdev/mfplane-mfpctl:branch-main
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: BR#n1 }
  sysctls:
  - sysctl: net.ipv4.ip_forward=1
  - sysctl: net.ipv6.conf.all.disable_ipv6=0
  - sysctl: net.ipv6.conf.default.disable_ipv6=0

node_configs:
- name: T1
  cmds:
  - cmd: ip link set net0 down
  - cmd: ip link set net0 address 52:54:00:01:00:01
  - cmd: ip link set net0 up
  - cmd: ip link set net1 down
  - cmd: ip link set net1 address 52:54:00:02:00:01
  - cmd: ip link set net1 up
  - cmd: nohup ./_t-rex-64 -i --astf --cfg ./cfg.yaml &
- name: BR
  cmds:
  - cmd: ip link add br0 type bridge
  - cmd: ip link set br0 up
  - cmd: ip link set hv1 master br0
  - cmd: ip link set l1 master br0
  - cmd: ip link set n1 master br0
- name: HV1
  cmds:
  - cmd: ip link set net0 down
  - cmd: ip link set net0 address 52:54:00:ff:00:01
  - cmd: ip link set net0 up
  - cmd: nohup vpp -c /etc/vpp/startup.conf &
- name: L1
  cmds:
  - cmd: ip link set net0 down
  - cmd: ip link set net0 address 52:54:00:ff:00:02
  - cmd: ip link set net0 up
- name: N1
  cmds:
  - cmd: ip link set net0 down
  - cmd: ip link set net0 address 52:54:00:ff:00:03
  - cmd: ip link set net0 up

postinit:
  cmds:
  - cmd: docker cp cfg.yaml T1:/opt/trex
  - cmd: >-
      docker cp new_connection_test.py
      T1:/opt/trex/automation/trex_control_plane/interactive/trex/examples/astf
  - cmd: |
      cat <<EOF > /tmp/hv1_exec.vpp
      create host-interface name net0
      create host-interface name net1
      create host-interface name net2
      set int state host-net0 up
      set int state host-net1 up
      set int state host-net2 up
      ip table add 10
      set int ip table host-net1 10

      set interface mac address host-net0 52:54:00:ff:00:01
      set interface mac address host-net1 52:54:00:01:00:02
      set interface mac address host-net2 52:54:00:02:00:02

      set int ip addr host-net0 2001::1/64
      set int ip addr host-net1 50.0.0.1/8
      set int ip addr host-net2 40.0.0.1/8
      ip route add table 10 20.0.0.0/8 via 50.0.0.2 host-net1
      ip route add 30.0.0.0/8 via 40.0.0.2 host-net2
      ip route add 142.0.0.0/8 via fe80::5054:ff:feff:2 host-net0
      ip route add fc00:ff00::/24 via fe80::5054:ff:feff:2 host-net0
      ip route add fc00:3100::/24 via fe80::5054:ff:feff:3 host-net0

      set ip arp host-net2 40.0.0.2 52:54:00:02:00:01
      set ip arp host-net1 50.0.0.2 52:54:00:01:00:01
      set int feature host-net0 ip4-not-enabled arc ip4-unicast disable

      sr localsid address fc00:1100:: behavior end
      sr localsid address fc00:1101:: behavior end.dt4 10
      set sr encaps source addr fc00:1100::

      sr policy add bsid cafe::10 next fc00:ff01:: fib-table 0
      sr steer l3 30.0.0.0/8 via bsid cafe::10 fib-table 10
      EOF

  - cmd: docker exec HV1 mkdir -p /etc/vpp
  - cmd: docker cp /tmp/hv1_exec.vpp HV1:/etc/vpp/exec.vpp
  - cmd: mkdir -p /var/run/netns
  - cmd: ln -s /proc/$(docker inspect L1 -f {{.State.Pid}})/ns/net /var/run/netns/L1
  - cmd: ln -s /proc/$(docker inspect N1 -f {{.State.Pid}})/ns/net /var/run/netns/N1
