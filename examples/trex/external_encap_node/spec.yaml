#
#   (net0) ---+
# T1         HV1 -- CLOS
#   (net1) ---+      |
#                    +--- L1
#                    |
#                    +--- N1
nodes:
- name: T1
  image: tinynetwork/trex:develop
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: HV1#net1 }
  - { name: net1, type: direct, args: HV1#net2 }
- name: HV1
  image: slankdev/vpp:19.04
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: CLOS#hv1 }
  - { name: net1, type: direct, args: T1#net0 }
  - { name: net2, type: direct, args: T1#net1 }
  sysctls:
  - sysctl: net.ipv4.ip_forward=1
- name: CLOS
  image: nicolaka/netshoot
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: hv1, type: direct, args: HV1#net0 }
  - { name: l1, type: direct, args: L1#net0 }
  - { name: n1, type: direct, args: N1#net0 }
  sysctls:
  - sysctl: net.ipv4.ip_forward=1
- name: L1
  image: nicolaka/netshoot
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: CLOS#l1 }
  sysctls:
  - sysctl: net.ipv4.ip_forward=1
- name: N1
  image: nicolaka/netshoot
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: CLOS#n1 }
  sysctls:
  - sysctl: net.ipv4.ip_forward=1

node_configs:
- name: T1
  cmds:
  - cmd: nohup ./_t-rex-64 -i --astf --cfg ./cfg.yaml &
- name: HV1
  cmds:
  - cmd: nohup vpp -c /etc/vpp/startup.conf &

postinit:
  cmds:
  - cmd: docker cp cfg.yaml T1:/opt/trex
  - cmd: docker cp tcp_open.py T1:/opt/trex
  - cmd: docker cp tcp_openclose.py T1:/opt/trex
  - cmd: >-
      docker cp new_connection_test.py
      T1:/opt/trex/automation/trex_control_plane/interactive/trex/examples/astf
  - cmd: |
      cat <<EOF > /tmp/hv1_exec.vpp
      create host-interface name net0
      create host-interface name net1
      create host-interface name net2
      set int state host-net0 up
      set int state host-net1 up
      set int state host-net2 up
      ip table add 10
      set int ip table host-net1 10

      set interface mac address host-net1 52:54:00:01:00:02
      set interface mac address host-net2 52:54:00:02:00:02

      set int ip addr host-net0 2001:13::1/64
      set int ip addr host-net1 20.0.0.1/8
      set int ip addr host-net2 30.0.0.1/8
      ip route add fc00:2::/64 via 2001:13::3
      ip route add fc00:2::/64 via 2001:14::4
      ip route add fc00:3::/64 via 2001:13::3

      sr localsid address fc00:1:: behavior end
      sr localsid address fc00:1::10 behavior end.dt4 10
      sr localsid address fc00:1::20 behavior end.dt4 20
      set sr encaps source addr fc00:1::

      sr policy add bsid cafe::10 next fc00:2::10 fib-table 0
      sr steer l3 30.0.0.0/8 via bsid cafe::10 fib-table 10
      EOF

  - cmd: docker exec HV1 mkdir -p /etc/vpp
  - cmd: docker cp /tmp/hv1_exec.vpp HV1:/etc/vpp/exec.vpp
