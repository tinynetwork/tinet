nodes:
- name: P4
  image: tinynetwork/p4bmv2:develop
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: vm1, type: direct, args: VM1#net0, addr: 52:54:00:00:00:01 }
  - { name: vm2, type: direct, args: VM2#net0, addr: 52:54:00:00:00:02 }
  - { name: vm3, type: direct, args: VM3#net0, addr: 52:54:00:00:00:03 }
  sysctls:
  - sysctl: net.ipv4.ip_forward=0
  - sysctl: net.ipv6.conf.all.forwarding=0
- name: VM1
  image: nicolaka/netshoot
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: P4#vm1, addr: 10:10:10:10:10:10 }
- name: VM2
  image: nicolaka/netshoot
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: P4#vm2, addr: 20:20:20:20:20:20 }
- name: VM3
  image: nicolaka/netshoot
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: P4#vm3, addr: 30:30:30:30:30:30 }

node_configs:
- name: P4
  cmds:
  - cmd: echo hello
  # - cmd: >-
  #     p4c --target bmv2 --arch v1model /main.p4
  #     --p4runtime-files p4info.txt -o /
  # - cmd: >-
  #     nohup simple_switch_grpc /main.json -i 1@vm1 -i 2@vm2 -i 3@vm3
  #     --nanolog ipc:///tmp/bm-0-log.ipc --log-console -L debug
  #     --notifications-addr ipc:///tmp/bmv2-0-notifications.ipc
  #     -- --cpu-port 255 &
  # - cmd: >-
  #     nohup python3 /main.py &
- name: VM1
  cmds:
  - cmd: ip addr add 10.0.1.2/24 dev net0
  - cmd: ip neigh replace 10.0.1.1 lladdr 52:54:00:00:00:01 dev net0
  - cmd: ip route add default via 10.0.1.1
- name: VM2
  cmds:
  - cmd: ip addr add 10.0.2.2/24 dev net0
  - cmd: ip neigh replace 10.0.2.1 lladdr 52:54:00:00:00:02 dev net0
  - cmd: ip route add default via 10.0.2.1
- name: VM3
  cmds:
  - cmd: ip addr add 10.0.3.2/24 dev net0
  - cmd: ip neigh replace 10.0.3.1 lladdr 52:54:00:00:00:03 dev net0
  - cmd: ip route add default via 10.0.3.1

postinit:
  cmds:
  - cmd: docker cp main.py P4:/main.py
  - cmd: docker cp main.p4 P4:/main.p4
  - cmd: docker cp runtime.txt P4:/runtime.txt
